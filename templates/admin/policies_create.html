{% extends 'base.html' %}

{% block title %}Créer Politique{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Créer une politique</h1>
    <div>
        <a href="{{ url_for('policies.index') }}" class="btn btn-sm btn-outline-secondary">Retour</a>
    </div>
</div>

<div class="row swap-on-mobile">
    <div class="col-md-8 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <form method="post" action="{{ url_for('policies.create') }}" novalidate>
                    <div class="mb-3">
                        <label class="form-label">Clé</label>
                        <input class="form-control" name="key" value="{{ request.form.get('key','') }}" placeholder="ex: mot_de_passe.duree_validite_jours" required>
                        <div class="form-text">Nom unique de la politique (utilisez des points pour la hiérarchie).</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Valeur</label>
                        <div id="policyValueContainer">
                            <textarea id="policyValueTextarea" name="value" class="form-control" rows="4" placeholder="Valeur">{{ request.form.get('value','') }}</textarea>
                            <input id="policyValueNumber" name="value" type="number" class="form-control" style="display:none" placeholder="Valeur numérique">
                            <div id="policyValueBool" class="form-check form-switch" style="display:none">
                                <input class="form-check-input" type="checkbox" id="policyValueCheckbox" name="value" value="true">
                                <label class="form-check-label" for="policyValueCheckbox">True</label>
                            </div>
                            <!-- Fallback hidden false for unchecked checkbox (placed after checkbox so checked=true takes precedence) -->
                            <input type="hidden" id="policyValueHidden" name="value" value="{{ request.form.get('value','') }}">
                        </div>
                        <div class="form-text">Ex: 90, true, or JSON list (séparé par virgules). <button id="formatJsonBtn" type="button" class="btn btn-sm btn-outline-secondary ms-2" style="display:none">Formater JSON</button></div>
                        <div class="invalid-feedback d-none" id="policyValueError"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type</label>
                            <select name="type" class="form-select">
                                <option value="string" {% if request.form.get('type','string')=='string' %}selected{% endif %}>string</option>
                                <option value="int" {% if request.form.get('type')=='int' %}selected{% endif %}>int</option>
                                <option value="json" {% if request.form.get('type')=='json' %}selected{% endif %}>json</option>
                                <option value="bool" {% if request.form.get('type')=='bool' %}selected{% endif %}>bool</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Active</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" role="switch" id="active" name="active" checked>
                                <label class="form-check-label" for="active">Active</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3">{{ request.form.get('description','') }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Commentaire (audit)</label>
                        <input class="form-control" name="comment" value="{{ request.form.get('comment','') }}">
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" type="submit">Créer</button>
                        <button type="button" class="btn btn-outline-secondary btn-edit" data-href="{{ url_for('policies.index') }}">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <strong>Aide & exemples</strong>
            </div>
            <div class="card-body small text-muted">
                <p><strong>Format clé :</strong> <code>mot_de_passe.duree_validite_jours</code></p>
                <p><strong>Exemples de valeurs :</strong>
                    <ul>
                        <li><code>90</code> (int)</li>
                        <li><code>true</code> (bool)</li>
                        <li><code>["admin","superadmin"]</code> (json)</li>
                    </ul>
                </p>
                <p>Les modifications sont auditées. Si une clé est marquée comme critique, elle peut nécessiter une approbation par un administrateur.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
