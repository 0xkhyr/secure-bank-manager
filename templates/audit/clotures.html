{% extends 'base.html' %}

{% block title %}Clôtures Journalières - Audit{% endblock %}

{% block content %}
<h1><i class="bi bi-calendar-check text-primary"></i> Clôtures Journalières</h1>
<div class="mb-4" style="display: flex; justify-content: space-between; align-items: center;">
    
    <a href="{{ url_for('audit.index') }}" class="btn btn-outline-secondary shadow-sm">
        <i class="bi bi-arrow-left"></i> Retour aux Logs
    </a>
    <form action="{{ url_for('audit.cloturer_hier') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-primary shadow-sm">
            <i class="bi bi-lock-fill"></i> Clôturer Hier
        </button>
    </form>
</div>

{% if not tout_valide %}
<div class="alert alert-danger shadow-sm border-start border-5 border-danger mb-4">
    <div class="d-flex">
        <div class="me-3">
            <i class="bi bi-exclamation-triangle-fill fs-3"></i>
        </div>
        <div>
            <h4 class="alert-heading">Alerte d'Intégrité : Clôtures Corrompues</h4>
            <p class="mb-0">Certaines signatures de clôture ne correspondent pas aux données enregistrées !</p>
            <ul class="mt-2 mb-0">
                {% for err in erreurs_cloture %}
                <li>{{ err }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-success shadow-sm border-start border-5 border-success mb-4 animate__animated animate__fadeIn">
    <div class="d-flex align-items-center">
        <i class="bi bi-shield-check-fill fs-4 me-2"></i> 
        <span>Toutes les clôtures quotidiennes sont cryptographiquement valides et signées.</span>
    </div>
</div>
{% endif %}

<div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle mb-0">
        <thead>
            <tr>
                <th style="width: 150px;">Date Journal</th>
                <th>Dernier Log</th>
                <th style="width: 40%;">Hash Racine</th>
                <th>Horodatage Clôture</th>
                <th class="text-end">État d'Intégrité</th>
            </tr>
        </thead>
                <tbody>
                    {% for cloture in clotures %}
                    <tr class="{% if cloture.id in ids_invalides %}table-danger-subtle{% endif %}">
                        <td class="px-4 fw-bold text-dark">
                            {{ cloture.date.strftime('%d/%m/%Y') }}
                        </td>
                        <td>
                            <a href="{{ url_for('audit.view', id=cloture.dernier_log_id) }}" class="btn btn-sm btn-outline-dark fw-bold px-3">
                                <i class="bi bi-tag-fill small"></i> #{{ cloture.dernier_log_id }}
                            </a>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <code class="text-primary bg-primary-subtle px-2 py-1 rounded small border border-primary-subtle">
                                    {{ cloture.hash_racine[:12] }}...{{ cloture.hash_racine[-12:] }}
                                </code>
                                <button class="btn btn-link btn-sm text-muted ms-2 p-0 copy-btn" onclick="copyHash(this, '{{ cloture.hash_racine }}')" title="Copier le hash complet">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-muted">
                            <i class="bi bi-clock-history me-1"></i> {{ cloture.cloture_le.strftime('%d/%m/%Y %H:%M') }}
                        </td>
                        <td class="text-end px-4">
                            {% if cloture.id in ids_invalides %}
                            <span class="badge rounded-pill bg-danger text-white px-3 py-2 shadow-sm animate__animated animate__pulse animate__infinite">
                                <i class="bi bi-x-circle-fill me-1"></i> CORROMPU
                            </span>
                            {% else %}
                            <span class="badge rounded-pill bg-success-subtle text-success border border-success-subtle px-3 py-2">
                                <i class="bi bi-shield-lock-fill me-1"></i> SÉCURISÉ
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <div class="opacity-25 mb-3">
                                <i class="bi bi-calendar-x" style="font-size: 4rem;"></i>
                            </div>
                            <h5 class="fw-bold">Aucune clôture archivée</h5>
                            <p class="mb-0">Les logs ne sont pas encore figés par un checkpoint quotidien.</p>
                            <div class="mt-3">
                                <small class="text-primary">Indice : Cliquez sur "Clôturer Hier" pour générer la première empreinte.</small>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

<div class="card bg-light border-0 mt-4 shadow-sm">
    <div class="card-body">
        <h6 class="card-title fw-bold text-primary mb-2">
            <i class="bi bi-info-circle-fill me-1"></i> À quoi sert la clôture ?
        </h6>
        <p class="card-text small text-muted mb-0">
            La clôture journalière est un mécanisme de <strong>Proof of Intactness</strong>. 
            Elle exporte le hash final de la journée et le signe cryptographiquement avec la clé HMAC du système. 
            Une fois clôturée, une journée devient immuable : toute modification d'un log passé invaliderait non seulement la chaîne d'audit, mais aussi le hash racine signé stocké ici.
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyHash(btn, text) {
    navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('i');
        const originalClass = icon.className;
        const originalText = btn.title;
        
        // Changement visuel
        icon.className = 'bi bi-check-lg text-success';
        btn.title = 'Copié !';
        
        // Feedback visuel (tooltip simu)
        const toast = document.createElement('div');
        toast.innerText = 'Copié !';
        toast.style.position = 'absolute';
        toast.style.background = '#22aa5e';
        toast.style.color = 'white';
        toast.style.padding = '4px 8px';
        toast.style.borderRadius = '4px';
        toast.style.fontSize = '12px';
        toast.style.zIndex = '1000';
        
        // Positionnement
        const rect = btn.getBoundingClientRect();
        toast.style.top = (rect.top + window.scrollY - 30) + 'px';
        toast.style.left = (rect.left + window.scrollX) + 'px';
        document.body.appendChild(toast);
        
        // Reset après 2 secondes
        setTimeout(() => {
            icon.className = originalClass;
            btn.title = originalText;
            document.body.removeChild(toast);
        }, 2000);
    });
}
</script>
{% endblock %}
