# Penetration Test Report  
## Authentication Endpoint â€“ `/auth/login`

---

## General Information

- **Target**: http://127.0.0.1:5000/auth/login  
- **Application**: SecureBank  
- **Framework**: Flask (Werkzeug / Python 3.12)  
- **Test Type**: Black-box  
- **Scope**: Authentication mechanism  
- **Tester**: Mohamed  
- **Date**: 22â€“23 December 2025  

---

## Executive Summary

A penetration test was conducted against the `/auth/login` endpoint of the SecureBank application.  
While a previously critical issue related to **credential disclosure** has been successfully remediated, several **medium and low severity vulnerabilities remain**.

These remaining issues could allow **user enumeration**, **account lockout abuse**, and **cross-site request forgery (CSRF)**, potentially weakening the overall authentication security posture.

Overall risk level: **MEDIUM**

---

## Findings Summary

| ID | Severity | Title | Status |
|----|----------|-------|--------|
| F-01 | ðŸ”´ Critical | Credentials disclosed in login page | âœ… Fixed |
| F-02 | ðŸŸ  Medium | Username enumeration via login responses | âœ… Fixed |
| F-03 | ðŸŸ  Medium | Account lockout abuse (DoS) | âœ… Fixed |
| F-04 | ðŸŸ  Medium | Missing CSRF protection | âœ… Fixed |
| F-05 | ðŸŸ¡ Low | Authentication state & timing disclosure | âœ… Fixed |
| F-06 | ðŸŸ¡ Low | Insecure session cookie attributes | âœ… Fixed |
| F-07 | ðŸŸ¡ Low | Server version disclosure | âœ… Fixed |

---

## Detailed Findings

---

### F-01: Credentials Disclosed in Login Page  
**Severity:** ðŸ”´ Critical  
**Status:** âœ… Fixed  

#### Description
Previously, valid credentials were exposed directly in the login page HTML as demo accounts.

#### Remediation Performed
The following content was removed from the frontend:
```html
admin / admin123
operateur / operateur123
```

---

### Actions taken since original report
Below are the remediation steps already implemented and the current status of other findings.

### F-02: Username enumeration via login responses
**Severity:** ðŸŸ  Medium
**Status:** âœ… Fixed

**Description**
The application previously returned distinct messages for unknown username, wrong password, and locked account, allowing user enumeration.

**Remediation Performed**
- All login failure responses were unified to a single generic message: **"Nom d'utilisateur ou mot de passe invalide."**. This prevents attackers from distinguishing username existence or account state from responses. Internal audit logs still record detailed failure reasons for forensics.
- Added unit tests that assert the same generic failure message is returned for unknown username, wrong password, and locked accounts.

---

### F-04: Missing CSRF protection
**Severity:** ðŸŸ  Medium
**Status:** âœ… Fixed

**Description**
The login form and other state-changing forms previously lacked CSRF protection.

**Remediation Performed**
- Implemented CSRF protection with dual modes:
  - Prefer `Flask-WTF` (if available) and use `CSRFProtect`.
  - If Flask-WTF is not installed (test/dev environments), a lightweight in-app CSRF fallback is used: a per-session token is generated and validated for unsafe HTTP methods (POST/PUT/PATCH/DELETE).
- Exposed `csrf_token()` in templates and added a `<meta name="csrf-token">` in the base template, plus a small JS helper that injects the token into POST forms. The login form includes a hidden token.
- Added `tests/test_csrf.py` to verify that forms without a token are rejected and valid forms with token succeed. Tests across the suite were updated to fetch and include CSRF tokens where needed.

---

### F-05: Authentication state & timing disclosure
**Severity:** ðŸŸ¡ Low
**Status:** âœ… Fixed

**Description**
Exact unlock timestamps previously disclosed in user-facing messages (e.g., "Compte verrouillÃ© jusqu'au ..."), leaking timing info to attackers.

**Remediation Performed**
- User-facing messages no longer expose exact unlock timestamps; the login response uses the generic failure message (see F-02). Exact times remain in audit logs for administrators only.

---

### Remaining / Open Items
- **F-03 Account lockout abuse (DoS)** â€” **âœ… Fixed**
  - Remediation Performed: Implemented per-IP rate limiting using `Flask-Limiter` on the `/auth/login` POST endpoint (default: **10 per minute**, configurable via `LOGIN_RATE_LIMIT`). Added `tests/test_rate_limiting.py` to assert HTTP 429 after exceeding the limit and validate per-IP independence. Note: for unit tests the limiter is disabled by default and enabled only for the dedicated rate-limit tests to avoid global test interference. Next recommendations: consider progressive challenges (CAPTCHA) after repeated failures and move to a shared rate-limit backend (Redis) for multi-instance deployments.
- **F-06 Insecure session cookie attributes** â€” **âœ… Fixed**
  - Remediation Performed: Added config variables and applied hardened defaults (`SESSION_COOKIE_HTTPONLY=True`, `SESSION_COOKIE_SAMESITE='Lax'`, `SESSION_COOKIE_SECURE` controllable via env). Added `tests/test_cookie_hardening.py` to verify session cookies include `HttpOnly`, `SameSite=Lax` and `Secure` when configured in the app. Note: `SESSION_COOKIE_SECURE` should be set to `1` in production (behind HTTPS).  
- **F-05 Authentication state & timing disclosure** â€” **âœ… Fixed (tests added)**
  - Verification: added a test to assert that locked-account login attempts do not expose ISO timestamps or unlock times to end users.
- **F-07 Server version disclosure** â€” **âœ… Fixed**
  - Remediation Performed: Added an `@app.after_request` middleware to strip common revealing headers (e.g., `Server`, `X-Powered-By`, `X-Generator`, `Server-Timing`) from responses to reduce server fingerprinting. Added `tests/test_server_headers.py` to verify headers are removed.

---

### Tests & Status
- New and updated tests added:
  - `tests/test_no_plaintext_credentials_in_repo.py` â€” scans repo for forbidden credential strings.
  - `tests/test_login_page_no_dev_creds.py` â€” ensures login page doesn't show demo creds in non-dev mode.
  - `tests/test_csrf.py` â€” verifies CSRF enforcement and acceptance.
  - `tests/test_auth.py` updates â€” asserts generic failure messages and uses CSRF tokens.
- Full test suite result after these changes: **36 passed** (warnings about naive UTC usage only).

---

### Next recommended actions
1. **F-03 (Rate-limiting / DoS mitigation)** â€” implemented per-IP rate limiting using `Flask-Limiter` on the `/auth/login` POST endpoint (default: **10 per minute**, configurable via `LOGIN_RATE_LIMIT`). Tests added (`tests/test_rate_limiting.py`) to assert HTTP 429 after exceeding the limit; different IPs are rate-limited independently. Note: for unit tests, rate limiting is disabled by default and enabled only for the dedicated rate-limit tests to avoid global test interference. Next recommendations: consider progressive challenges (CAPTCHA) after repeated failures and move to a shared rate-limit backend (Redis) for multi-instance deployments.
2. **F-06 / F-07 (Cookie & header hardening)** â€” quick configuration and middleware changes; low effort, high impact.
3. **CI integration** â€” add a CI check that runs the repo-scan test to prevent accidental reintroduction of plaintext credentials into repo files.

If you'd like, I can implement F-03 next or handle the cookie/header hardening and CI checks first â€” tell me which you prefer and I will proceed.